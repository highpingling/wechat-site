<script>
  // === 后端接口地址 ===
  const BACKEND_CHAT_URL = "https://sonnet.highpingling.workers.dev/"; 
  const BACKEND_TTS_URL = "https://tts.highpingling.workers.dev/";

  // === 默认头像与壁纸路径 ===
  const DEFAULT_ME_AVATAR = "./avatar_me.png";
  const DEFAULT_BOYFRIEND_AVATAR = "./avatar_boyfriend.png";

  // ✅ 这里是你新的默认壁纸
  const DEFAULT_WALLPAPER = "https://raw.githubusercontent.com/highpingling/wechat-site/refs/heads/main/wallpaper.png";

  // === 用户信息与壁纸设置 ===
  let currentUser = JSON.parse(localStorage.getItem('currentUser')) || { name: "我", avatar: DEFAULT_ME_AVATAR };
  let boyfriend = JSON.parse(localStorage.getItem('boyfriend')) || { name: "虚拟男友", avatar: DEFAULT_BOYFRIEND_AVATAR };

  // ✅ 初始加载壁纸时，优先用 localStorage，否则使用 GitHub 默认图
  let chatWallpaper = localStorage.getItem('chatWallpaper') || DEFAULT_WALLPAPER;

  const chatMessages = document.getElementById("chat-messages");
  const messageInput = document.getElementById("message-input");
  const sendButton = document.getElementById("send-button");
  const audioPlayer = document.getElementById("player");
  const settingsModal = document.getElementById("settingsModal");

  const myNameInput = document.getElementById("my-name-input");
  const myAvatarUrlInput = document.getElementById("my-avatar-url-input");
  const myAvatarFileInput = document.getElementById("my-avatar-file-input");
  const myAvatarPreview = document.getElementById("my-avatar-preview");

  const boyfriendNameInput = document.getElementById("boyfriend-name-input");
  const boyfriendAvatarUrlInput = document.getElementById("boyfriend-avatar-url-input");
  const boyfriendAvatarFileInput = document.getElementById("boyfriend-avatar-file-input");
  const boyfriendAvatarPreview = document.getElementById("boyfriend-avatar-preview");
  const boyfriendNameDisplay = document.getElementById("boyfriend-name-display");
  const initialBoyfriendAvatarDisplay = document.getElementById("initial-boyfriend-avatar-display");

  const chatWallpaperUrlInput = document.getElementById("chat-wallpaper-url-input");
  const chatWallpaperFileInput = document.getElementById("chat-wallpaper-file-input");
  const chatWallpaperPreview = document.getElementById("chat-wallpaper-preview");


  // === 初始化设置 ===
  function loadSettings() {
      myNameInput.value = currentUser.name;
      myAvatarUrlInput.value = currentUser.avatar.startsWith('http') ? currentUser.avatar : '';
      myAvatarPreview.src = currentUser.avatar;

      boyfriendNameInput.value = boyfriend.name;
      boyfriendAvatarUrlInput.value = boyfriend.avatar.startsWith('http') ? boyfriend.avatar : '';
      boyfriendAvatarPreview.src = boyfriend.avatar;

      chatWallpaperUrlInput.value = chatWallpaper.startsWith('http') ? chatWallpaper : '';
      chatWallpaperPreview.src = chatWallpaper;
      chatWallpaperPreview.style.display = 'block';

      boyfriendNameDisplay.textContent = boyfriend.name;
      if (initialBoyfriendAvatarDisplay) initialBoyfriendAvatarDisplay.src = boyfriend.avatar;

      applyWallpaper();
  }

  // ✅ 应用壁纸：如果 localStorage 没有就加载 GitHub 默认
  function applyWallpaper() {
    if (chatWallpaper) {
      chatMessages.style.backgroundImage = `url('${chatWallpaper}')`;
    } else {
      chatMessages.style.backgroundImage = `url('${DEFAULT_WALLPAPER}')`;
    }
  }

  // === 添加消息到界面 ===
  function addMessage(text, sender, isBoyfriendMessage = false) {
    const messageDiv = document.createElement("div");
    messageDiv.classList.add("message", sender === "me" ? "me" : "boyfriend");

    const avatarSrc = sender === "me" ? currentUser.avatar : boyfriend.avatar;
    const avatarAlt = sender === "me" ? currentUser.name : boyfriend.name;
    const avatarHtml = `<img src="${avatarSrc}" class="message-avatar" alt="${avatarAlt}头像">`;

    const contentHtml = `<div class="message-content"><p class="message-text">${text}</p></div>`;
    const ttsButtonHtml = isBoyfriendMessage ? '<button class="tts-button" onclick="speakText(this)">转语音</button>' : '';

    if (sender === "me") {
      messageDiv.innerHTML = contentHtml + avatarHtml;
    } else {
      messageDiv.innerHTML = avatarHtml + contentHtml + ttsButtonHtml;
    }

    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  // === 发送消息 ===
  async function sendMessage() {
    const messageText = messageInput.value.trim();
    if (messageText === "") return;

    addMessage(messageText, "me");
    messageInput.value = "";

    const loadingDiv = document.createElement("div");
    loadingDiv.classList.add("loading-indicator");
    loadingDiv.textContent = "对方正在输入...";
    chatMessages.appendChild(loadingDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;

    try {
      const response = await fetch(BACKEND_CHAT_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          message: messageText,
          user_name: currentUser.name,
          boyfriend_name: boyfriend.name
        }),
      });

      if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);

      const data = await response.json();
      chatMessages.removeChild(loadingDiv);

      const replies = data.reply.split('\n').filter(r => r.trim() !== '');
      for (const reply of replies) addMessage(reply.trim(), "boyfriend", true);

    } catch (error) {
      console.error("发送消息失败:", error);
      chatMessages.removeChild(loadingDiv);
      addMessage("我暂时无法回答你的问题，请稍后再试。", "boyfriend");
    }
  }

  // === 文本转语音 ===
  async function speakText(button) {
    const text = button.previousElementSibling.querySelector('.message-text').textContent;
    if (!text) return;

    button.disabled = true;
    button.textContent = "加载语音...";
    try {
      const res = await fetch(BACKEND_TTS_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text })
      });
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      audioPlayer.src = url;
      audioPlayer.play();
      audioPlayer.onended = () => {
        URL.revokeObjectURL(url);
        button.disabled = false;
        button.textContent = "转语音";
      };
    } catch (err) {
      alert("语音合成失败，请检查后端服务。");
      button.disabled = false;
      button.textContent = "转语音";
    }
  }

  // === 打开/关闭设置 ===
  function openSettings() {
    loadSettings();
    settingsModal.style.display = "flex";
  }
  function closeSettings() {
    settingsModal.style.display = "none";
  }

  // === 保存设置 ===
  function saveSettings() {
    currentUser.name = myNameInput.value.trim() || "我";
    boyfriend.name = boyfriendNameInput.value.trim() || "虚拟男友";
    localStorage.setItem('currentUser', JSON.stringify(currentUser));
    localStorage.setItem('boyfriend', JSON.stringify(boyfriend));

    if (chatWallpaperFileInput.files[0]) {
      chatWallpaper = chatWallpaperPreview.src;
    } else if (chatWallpaperUrlInput.value.trim()) {
      chatWallpaper = chatWallpaperUrlInput.value.trim();
    } else {
      chatWallpaper = DEFAULT_WALLPAPER;
    }
    localStorage.setItem('chatWallpaper', chatWallpaper);

    applyWallpaper();
    closeSettings();
    alert("设置已保存！");
  }

  // === 初始化监听 ===
  sendButton.addEventListener("click", sendMessage);
  messageInput.addEventListener("keypress", e => { if (e.key === "Enter") sendMessage(); });
  document.addEventListener("DOMContentLoaded", () => { loadSettings(); });
</script>
